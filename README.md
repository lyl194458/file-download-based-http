# file-download-based-http
一．项目名称：基于HTTP的文件下载器
分析：客户端要下载一个文件，首先请求服务端，服务端将该文件传送给客户端，客户端将其保存到本地，这就完成了一个下载过程。
二．需求：
1.多线程下载 2.断点传输 3.显示进度 4.判断是否容得下下载文件 5.限度(扩展)
已经实现的功能：
1.多线程下载
2.断点续传
3.实时的显示当前进度
4.能够限速
5.支持重定向
6.支持响应报文中含有chunked字段的url
7.能够判断磁盘已满的异常
8.能够处理下载中途断网情况
三．实现过程：
1.根据输入的url先根据正则表达式判断其是否为一个合法的url,之后根据合法的url解析出访问主机的域名，端口号，文件资源的请求路径。
2.根据上一步得到的主机信息封装http请求头，其中，请求首行包含请求方法，url,协议版本，请求头包含Content-length，Range，Connection字段，分别用于获取请求文件大小，设置请求字段范围，设置连接方式。
3.根据响应投获取要下载文件大小，再通过计算当前所有磁盘可用大小，当要下载的文件大小大于磁盘剩余大小则返回，这里有两种情况：第一种就是通常的响应头中都有文件大小字段，第二种就是响应头中没有文件大小字段，而是有一个叫做tansfer-encoding: chunked字段，此时说明服务端采用的是分块传输，即我们不能够获取请求文件大小，只能通过该类型的响应头进行分块接收。
4.根据访问主机的域名得到ip地址后，由主机域名，端口号组织好访问主机的地址信息，然后客户端这边创建自己的socket,并且与组织好的主机地址建立连接，之后就将组织好的http请求头发送给访问主机。
5.将请求头发送到访问主机后，从主机接收响应信息，此时如果响应状态码是2xx则我们可以直接读取响应信息，但是如果是3xx说明我们需要对本次请求进行重定向，即需要从响应头中找到Location字段，提取出重定向之后的url,再次回调下载函数重新请求资源，否则从响应信息中提取本次请求下载的文件大小，按照文件大小将文件分割成若干个以块为单位的小文件，然后根据文件块大小，再次封装请求下载头，并且设置好Range字段表明此次要下载的文件起始位置与终止位置，重新发起http请求。
6.按照文件分成的块数启动多线程开始下载(每个线程请求固定的字段，然后从响应头中读取两个回车换行之后的内容也就是正文消息)，每个线程开始下载时，都先要检查对应块的记录文件，记录文件记录着每一块文件已经下载的大小，因此下载线程如果发现存在记录文件，则说明之前下载过，则需要读取每一块文件已经下载的大小，然后封装该块文件的下载请求时就要设置好对应的Range字段（需要偏移到已经下载位置）；否则如果发现所有块文件的记录文件不存在，那么说明要从头开始下载，则需要将记录文件清空，并且封装好请求头并且设置好Range字段发送本快文件的下载请求。并且每个线程进去下载开始后，将已下载块数加一，以便下一个线程就从下一块开始下载。
7.当响应头中没有文件大小Content-Range字段时，并且有字段transfer-enccoding字段时，这说明本次需要分块传输，这种数据格式就是每一块数据的头上有一个十六进制数代表这一块的数据大小，紧接着就是这块数据内容，并且数据大小和正文内容后面带有\r\n,我们可以根据这个标志循环读取每一块的数据，并且跳过这个大小标志和换行标志，直到数据读完的标识是大小为0的块和一个\r\n。
8.对于进度显示，可以通过一个监控线程监控并且显示当前所有线程已下载的文件总和hasdown，以及要下载的文件总大小filesize，可以看到当前下载文件的进度情况。
9.创建一个全局的文件，用于保存最终下载的文件，每个线程下载的块根据其发送头中的Range字段的起始位置，设置这个全局文件的文件指针，然后将接收到对应的正文数据放到文件的对应位置，即这个过程是直接将下载的文件写到本地，无需合并过程。



